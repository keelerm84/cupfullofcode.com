<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.98.0"><link rel="shortcut icon" href=https://cdn.jsdelivr.net/gh/dsrkafuu/dsr-cdn-main@1/images/favicons/dsrca.ico><title>Deploying Hugo With Github Actions - Cup Full of Code</title><meta name=author content="Matthew M. Keeler"><meta name=description content="Automating hugo static site deployments with GitHub Actions"><meta name=keywords content="devops,hugo,github"><meta property="og:title" content="Deploying Hugo With Github Actions"><meta name=twitter:title content="Deploying Hugo With Github Actions"><meta property="og:type" content="article"><meta property="og:url" content="https://cupfullofcode.com/blog/2018/12/21/deploying-hugo-with-github-actions/"><meta property="og:description" content="Automating hugo static site deployments with GitHub Actions"><meta name=twitter:description content="Automating hugo static site deployments with GitHub Actions"><meta name=twitter:card content="summary"><meta property="article:published_time" content="2018-12-21T00:08:49-05:00"><meta property="article:modified_time" content="2018-12-21T00:08:49-05:00"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://cupfullofcode.com/assets/css/fuji.min.css><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-55725869-1")</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-55725869-1"></script></head><body data-theme=auto data-theme-auto=false><script data-cfasync=false>var fujiThemeData=localStorage.getItem("fuji_data-theme");fujiThemeData?fujiThemeData!=="auto"&&document.body.setAttribute("data-theme",fujiThemeData==="dark"?"dark":"light"):localStorage.setItem("fuji_data-theme","auto")</script><header><div class="container-lg clearfix"><div class="col-12 header"><a class=title-main href=https://cupfullofcode.com>Cup Full of Code</a>
<span class=title-sub>The personal site of Matthew M. Keeler</span></div></div></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h2 class="post-item post-title"><a href=https://cupfullofcode.com/blog/2018/12/21/deploying-hugo-with-github-actions/>Deploying Hugo With Github Actions</a></h2><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2018-12-21</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;853 words</span>
<span><i class="iconfont icon-time-sharp"></i>&nbsp;5 minutes</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=https://cupfullofcode.com/tags/devops>devops</a>&nbsp;<a href=https://cupfullofcode.com/tags/hugo>hugo</a>&nbsp;<a href=https://cupfullofcode.com/tags/github>github</a>&nbsp;</span></div><div class="post-content markdown-body"><p>I recently converted this site from <a href=https://www.staticgen.com/hexo target=_blank>hexo</a> to
<a href=https://gohugo.io target=_blank>hugo</a>. Hugo is fantastic but the lack of a built-in
deployment mechanism leaves much to be desired.</p><p>The Hugo documentation provides an <a href=https://gohugo.io/hosting-and-deployment/hosting-on-github/ target=_blank>example of how to deploy your site to
GitHub pages</a>, but
I&rsquo;m too lazy to run a script for every deployment. Enter <a href=https://developer.github.com/actions/ target=_blank>GitHub
Actions</a>.</p><p>GitHub Actions is the newest offering from GitHub, offering a simple interface
to automate actions based off a variety of special repository events. So how
can we use this to automatically build and publish our hugo sites?</p><p>We are going to need the following:</p><ul><li>A deployment key and secret key value used to give our build process write access to our repository</li><li>A Dockerfile that builds and pushes our commits</li><li>A new GitHub Actions workflow file to tie it all together</li></ul><h3 id=deployment--secret-keys>Deployment / Secret Keys</h3><p>We need to configure a set of writable deployment keys so that we can push our generated site to the gh-pages branch. To generate these keys, we can run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh-keygen -t ed25519 -f ~/.ssh/cupfullofcode-deploy</span></span></code></pre></div><p>The public key (cupfullofcode-deploy.pub) needs to be saved as a write-enabled
deployment key.</p><p>The private key (cupfullofcode-deploy) needs to be saved as a secret. NOTE:
Make sure you name the secret GH_ACTION_DEPLOY_KEY. We will need to
reference this later.</p><h3 id=dockerfile>Dockerfile</h3><p>Now that we have a writable key to use, we need to configure a Docker
image capable of building and publishing our site.</p><p>The Dockerfile is included below, along with comments explaining each
section. The biggest thing to note is the <code>ARG GH_ACTION_DEPLOY_KEY</code> line.</p><p>We will use that functionality to provide our private key to the container in a later step,
allowing us to commit changes to our repository.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#75715e># Start with a bare bones image that already has hugo installed</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> klakegg/hugo:0.52-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Allow setting GH_ACTION_DEPLOY_KEY via the docker build command</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GH_ACTION_DEPLOY_KEY<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># We need git to commit and openssh to push</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add git openssh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git config --global user.email <span style=color:#e6db74>&#34;keelerm84@gmail.com&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git config --global user.name <span style=color:#e6db74>&#34;Matthew M. Keeler&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Use our build arg to store our private key. Run ssh-keyscan so we aren&#39;t</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># prompted to trust the github.com host when we push our changes</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p ~/.ssh/ <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    echo <span style=color:#e6db74>&#34;</span>$GH_ACTION_DEPLOY_KEY<span style=color:#e6db74>&#34;</span> &gt; ~/.ssh/id_rsa <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    chmod <span style=color:#ae81ff>600</span> ~/.ssh/id_rsa <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /site/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> . /site/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># By default, GH Actions will run with your repo checked out using the https</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># protocol. This prevents us from being able to push using our stored key, so </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># we change it to git@</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git remote rm origin <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git remote add origin git@github.com:keelerm84/cupfullofcode.com <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git fetch<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># My theme is configured as a submodule so I need to pull it in. You may not</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># need this if you have committed your theme directly to your repository.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git submodule update --init --recursive<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Checkout the gh-pages branch as a working tree so that generated hugo files</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># are ready to be committed in that branch.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git worktree add -B gh-pages public origin/gh-pages<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Build the site of course</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> hugo<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Commit and push (NOTE: --allow-empty is here just in case I push a change that</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># results in no change to the generated site, like updating a README or</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># these build scripts).</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd public <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git add --all <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git commit -m <span style=color:#e6db74>&#34;Site updated: `date +&#39;%Y-%m-%d %H:%M:%S&#39;`&#34;</span> --allow-empty <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git push origin gh-pages:gh-pages</span></span></code></pre></div><h3 id=github-workflow-file>GitHub Workflow File</h3><p>We now have a Docker container that will build and publish the site and we have
write-enabled access keys. All that is left is to hook up these pieces through actions.</p><p>I&rsquo;ll show you how to configure it via the UI, but you can just copy the final
file shown below.</p><p>The first step is to configure the event on which this workflow should
execute. Currently, GitHub only supports push events to branches for public
repositories, but since that&rsquo;s what we need we&rsquo;re in good shape.</p><figure><img src=https://cupfullofcode.com/images/blog/deploying-hugo-with-github-actions/configure-events.png></figure><p>While pushing to a branch is perfect for our use case, we don&rsquo;t want to deploy
when we push a change to ANY branch. If we did, our site would be deployed any
time someone pushes a feature branch.</p><p>Luckily, we have the option of adding a filter step which allows us to halt
execution of the workflow if the branch isn&rsquo;t master.</p><figure><img src=https://cupfullofcode.com/images/blog/deploying-hugo-with-github-actions/configure-filters.png></figure><p>We finish the workflow off by building our Docker image. You can see in the
screenshot that we pass in the GH_ACTION_DEPLOY_KEY as a build argument,
setting it to some environment variable. This environment variable will be
populated if you check the appropriate box under the secrets section.</p><figure><img src=https://cupfullofcode.com/images/blog/deploying-hugo-with-github-actions/configure-docker.png></figure><p>You can now commit this configuration. A new file will be commited under
<code>.github</code> in the root of your repository. I have reproduced this file below for
your convenience.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>workflow &#34;Publish Site&#34; {
</span></span><span style=display:flex><span>  on = &#34;push&#34;
</span></span><span style=display:flex><span>  resolves = [&#34;Docker Build And Publish&#34;]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>action &#34;Master Branch Only&#34; {
</span></span><span style=display:flex><span>  uses = &#34;actions/bin/filter@b2bea07&#34;
</span></span><span style=display:flex><span>  args = &#34;branch master&#34;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>action &#34;Docker Build And Publish&#34; {
</span></span><span style=display:flex><span>  uses = &#34;actions/docker/cli@76ff57a&#34;
</span></span><span style=display:flex><span>  needs = [&#34;Master Branch Only&#34;]
</span></span><span style=display:flex><span>  args = &#34;build --build-arg GH_ACTION_DEPLOY_KEY=\&#34;$GH_ACTION_DEPLOY_KEY\&#34; .&#34;
</span></span><span style=display:flex><span>  secrets = [&#34;GH_ACTION_DEPLOY_KEY&#34;]
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>At this point, you have everything setup to automatically build and publish
your site whenever you push to master. Happy blogging!</p></div></article></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=https://cupfullofcode.com/>Home</a></li><li><a href=https://cupfullofcode.com/about/>About</a></li><li><a href=https://cupfullofcode.com/blog/>Blog</a></li><li><a href=https://cupfullofcode.com/search/>Search</a></li><li><a href=https://cupfullofcode.com/index.xml>RSS</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/keelerm84 target=_blank><span>GitHub</span></a></li><li><a href=https://twitter.com/keelerm84 target=_blank><span>Twitter</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=https://cupfullofcode.com/tags/automation/>automation</a></span>
<span><a href=https://cupfullofcode.com/tags/devops/>devops</a></span>
<span><a href=https://cupfullofcode.com/tags/elisp/>elisp</a></span>
<span><a href=https://cupfullofcode.com/tags/emacs/>emacs</a></span>
<span><a href=https://cupfullofcode.com/tags/github/>github</a></span>
<span><a href=https://cupfullofcode.com/tags/hugo/>hugo</a></span>
<span><a href=https://cupfullofcode.com/tags/logic/>logic</a></span>
<span><a href=https://cupfullofcode.com/tags/org-mode/>org-mode</a></span>
<span><a href=https://cupfullofcode.com/tags/php/>php</a></span>
<span><a href=https://cupfullofcode.com/tags/projectile/>projectile</a></span>
<span><a href=https://cupfullofcode.com/tags/refactoring/>refactoring</a></span>
<span><a href=https://cupfullofcode.com/tags/screen/>screen</a></span>
<span><a href=https://cupfullofcode.com/tags/snippets/>snippets</a></span>
<span><a href=https://cupfullofcode.com/tags/utilities/>utilities</a></span>
<span><a href=https://cupfullofcode.com/tags/vim/>vim</a></span>
<span><a href=https://cupfullofcode.com/tags/zsh/>zsh</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><ul><li><a href=#deployment--secret-keys>Deployment / Secret Keys</a></li><li><a href=#dockerfile>Dockerfile</a></li><li><a href=#github-workflow-file>GitHub Workflow File</a></li></ul></li></ul></nav></div></aside></div><div class=btn><div class=btn-menu id=btn-menu><i class="iconfont icon-grid-sharp"></i></div><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div><aside class=sidebar-mobile style=display:none><div class=sidebar-wrapper><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=https://cupfullofcode.com/>Home</a></li><li><a href=https://cupfullofcode.com/about/>About</a></li><li><a href=https://cupfullofcode.com/blog/>Blog</a></li><li><a href=https://cupfullofcode.com/search/>Search</a></li><li><a href=https://cupfullofcode.com/index.xml>RSS</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/keelerm84 target=_blank><span>GitHub</span></a></li><li><a href=https://twitter.com/keelerm84 target=_blank><span>Twitter</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=https://cupfullofcode.com/tags/automation/>automation</a></span>
<span><a href=https://cupfullofcode.com/tags/devops/>devops</a></span>
<span><a href=https://cupfullofcode.com/tags/elisp/>elisp</a></span>
<span><a href=https://cupfullofcode.com/tags/emacs/>emacs</a></span>
<span><a href=https://cupfullofcode.com/tags/github/>github</a></span>
<span><a href=https://cupfullofcode.com/tags/hugo/>hugo</a></span>
<span><a href=https://cupfullofcode.com/tags/logic/>logic</a></span>
<span><a href=https://cupfullofcode.com/tags/org-mode/>org-mode</a></span>
<span><a href=https://cupfullofcode.com/tags/php/>php</a></span>
<span><a href=https://cupfullofcode.com/tags/projectile/>projectile</a></span>
<span><a href=https://cupfullofcode.com/tags/refactoring/>refactoring</a></span>
<span><a href=https://cupfullofcode.com/tags/screen/>screen</a></span>
<span><a href=https://cupfullofcode.com/tags/snippets/>snippets</a></span>
<span><a href=https://cupfullofcode.com/tags/utilities/>utilities</a></span>
<span><a href=https://cupfullofcode.com/tags/vim/>vim</a></span>
<span><a href=https://cupfullofcode.com/tags/zsh/>zsh</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><ul><li><a href=#deployment--secret-keys>Deployment / Secret Keys</a></li><li><a href=#dockerfile>Dockerfile</a></li><li><a href=#github-workflow-file>GitHub Workflow File</a></li></ul></li></ul></nav></div></div></aside></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2022
<a href=https://cupfullofcode.com>Matthew M. Keeler</a>
| <a href=https://github.com/keelerm84/cupfullofcode.com>Source code</a>
| Powered by <a href=https://github.com/dsrkafuu/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.27.0/components/prism-core.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/autoloader/prism-autoloader.min.js></script>
<script defer src=https://cupfullofcode.com/assets/js/fuji.min.js></script></body></html>